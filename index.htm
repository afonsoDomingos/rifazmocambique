<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8">
  <title>Rifa Semanal ‚Äî 25.000 MZN</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
      padding: 2rem 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .card {
      background: #fff;
      color: #000;
      padding: 2rem 1.5rem;
      border: 1px solid #000;
      border-radius: 12px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .prize {
      font-size: 1.8rem;
      font-weight: 800;
      margin: 0.5rem 0;
      color: #000;
    }
    
    .info {
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
      line-height: 1.5;
      color: #333;
    }
    
    .details {
      background: #f9f9f9;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      font-size: 0.85rem;
      text-align: left;
      border: 1px solid #ddd;
    }
    
    .details ul {
      list-style: none;
      padding: 0;
    }
    
    .details li {
      margin-bottom: 0.5rem;
      position: relative;
      padding-left: 1.5rem;
    }
    
    .details li:before {
      content: "‚úì";
      position: absolute;
      left: 0;
      font-weight: bold;
    }
    
    .field {
      margin-bottom: 1.25rem;
      text-align: left;
    }
    
    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
    input, select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #000;
      border-radius: 8px;
      font-size: 1rem;
      background: #fff;
      transition: border-color 0.2s;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #333;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.2);
    }
    
    button {
      width: 100%;
      padding: 1rem;
      background: #000;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    button:hover:not(:disabled) {
      background: #333;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .status {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 8px;
      font-size: 0.9rem;
      min-height: 20px;
      border: 1px solid transparent;
    }
    
    .status.loading {
      background: #f5f5f5;
      border-color: #000;
    }
    
    .status.success {
      background: #fff;
      border-color: #000;
    }
    
    .status.error {
      background: #fff;
      border-color: #000;
      color: #000;
    }
    
    .money {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .footer {
      margin-top: 2rem;
      font-size: 0.75rem;
      color: #666;
    }
    
    .ticket-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
      gap: 5px;
      margin-bottom: 1.5rem;
      max-height: 200px;
      overflow-y: auto;
      padding: 0.5rem;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    
    .ticket-btn {
      padding: 0.5rem;
      background: #fff;
      border: 1px solid #000;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .ticket-btn:hover {
      background: #000;
      color: #fff;
    }
    
    .ticket-btn.selected {
      background: #000;
      color: #fff;
      font-weight: 600;
    }
    
    .ticket-btn:disabled {
      background: #ddd;
      color: #666;
      cursor: not-allowed;
    }
    
    .gift-box {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .gift-box.active {
      display: flex;
    }
    
    .gift-content {
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      text-align: center;
      position: relative;
      animation: openGift 1.5s ease forwards;
    }
    
    .gift-content .ticket-code {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 1rem 0;
      color: #000;
    }
    
    .close-gift {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
    }
    
    @keyframes openGift {
      0% {
        transform: scale(0);
        opacity: 0;
      }
      50% {
        transform: scale(1.2);
        opacity: 1;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    @media (max-width: 480px) {
      body { padding: 1rem; }
      .card { padding: 1.5rem 1rem; }
      h2 { font-size: 1.25rem; }
      .prize { font-size: 1.5rem; }
      .money { font-size: 1.75rem; }
      .ticket-grid { grid-template-columns: repeat(auto-fit, minmax(40px, 1fr)); }
    }
    
    @media (min-width: 768px) {
      .card { padding: 2.5rem 2rem; max-width: 450px; }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="money">Pr√™mio</div>
    <h2>Rifa Semanal</h2>
    <div class="prize">25.000 MZN</div>
    <p class="info">150 MZN por bilhete<br>Sorteio: Todo Domingo √†s 23:59</p>
    
    <div class="details">
      <ul>
        <li>Bilhetes limitados: 1.000 por rifa</li>
        <li>Pr√™mio entregue em dinheiro via M-Pesa</li>
        <li>Sorteio ao vivo no Instagram @rifa_mz</li>
        <li>Resultado enviado por SMS e email</li>
        <li>Organizado por: Rifa Legal Mo√ßambique</li>
      </ul>
    </div>
    
    <div class="field">
      <label>Escolha seu n√∫mero (1 a 1000)</label>
      <div class="ticket-grid" id="ticketGrid"></div>
      <input type="hidden" id="selectedTicket" required>
    </div>
    
    <form id="rifaForm">
      <div class="field">
        <label>Nome completo</label>
        <input id="name" placeholder="Ex: Jo√£o Silva" required>
      </div>
      
      <div class="field">
        <label>Telefone (+258)</label>
        <input id="phone" type="tel" placeholder="88XXXXXXXX" required>
      </div>
      
      <div class="field">
        <label>N¬∫ de bilhetes</label>
        <select id="quantity">
          <option value="1">1 (150 MZN)</option>
          <option value="2">2 (300 MZN)</option>
          <option value="5">5 (750 MZN)</option>
          <option value="10">10 (1.500 MZN)</option>
        </select>
      </div>
      
      <button type="submit" id="buyBtn">Comprar via M-Pesa</button>
    </form>
    
    <div id="status" class="status"></div>
    
    <div class="footer">
      Rifa autorizada ‚Ä¢ Suporte: +258 84 123 4567
    </div>
  </div>
  
  <div class="gift-box" id="giftBox">
    <div class="gift-content">
      <button class="close-gift" id="closeGift">‚úï</button>
      <div>üéÅ</div>
      <div class="ticket-code" id="ticketCode"></div>
      <p>Seu n√∫mero da rifa foi reservado!</p>
    </div>
  </div>

<script>
// Simula√ß√£o de n√∫meros dispon√≠veis (1 a 1000, com alguns indispon√≠veis)
const totalTickets = 1000;
const takenTickets = [2, 5, 10, 500]; // Exemplo de n√∫meros j√° escolhidos
const ticketGrid = document.getElementById('ticketGrid');
const selectedTicketInput = document.getElementById('selectedTicket');
const giftBox = document.getElementById('giftBox');
const ticketCode = document.getElementById('ticketCode');
const closeGift = document.getElementById('closeGift');

function generateTicketGrid() {
  ticketGrid.innerHTML = '';
  for (let i = 1; i <= totalTickets; i++) {
    const btn = document.createElement('button');
    btn.className = 'ticket-btn';
    btn.textContent = i;
    btn.dataset.ticket = i;
    if (takenTickets.includes(i)) {
      btn.disabled = true;
    } else {
      btn.addEventListener('click', () => selectTicket(i));
    }
    ticketGrid.appendChild(btn);
  }
}

function selectTicket(ticketNumber) {
  const prevSelected = ticketGrid.querySelector('.ticket-btn.selected');
  if (prevSelected) prevSelected.classList.remove('selected');
  
  const selectedBtn = ticketGrid.querySelector(`[data-ticket="${ticketNumber}"]`);
  selectedBtn.classList.add('selected');
  selectedTicketInput.value = ticketNumber;
  
  // Mostrar anima√ß√£o da caixa de presente
  ticketCode.textContent = `Bilhete #${ticketNumber}`;
  giftBox.classList.add('active');
}

closeGift.addEventListener('click', () => {
  giftBox.classList.remove('active');
});

generateTicketGrid();

document.getElementById('rifaForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const btn = document.getElementById('buyBtn');
  const status = document.getElementById('status');
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const qty = parseInt(document.getElementById('quantity').value);
  const ticket = selectedTicketInput.value;
  
  if (!name || !phone.match(/^88\d{8}$/) || !ticket) {
    status.textContent = 'Nome, telefone (+25888...) e n√∫mero da rifa s√£o obrigat√≥rios.';
    status.className = 'status error';
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'A processar...';
  status.textContent = 'Iniciando pagamento M-Pesa...';
  status.className = 'status loading';
  
  try {
    const res = await fetch('/api/create-payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, phone: '+258' + phone, qty, ticket, amount: qty * 150 })
    });
    
    const data = await res.json();
    
    if (!res.ok) throw new Error(data.message || 'Erro no pagamento');
    
    if (data.checkout_url) {
      status.innerHTML = `Clique para pagar: <a href="${data.checkout_url}" target="_blank" style="color:#000;font-weight:600;">Abrir M-Pesa</a>`;
    } else {
      status.textContent = 'Aguarde o SMS com instru√ß√µes de pagamento (*150*00#).';
    }
    
    status.className = 'status success';
    pollPayment(data.payment_id);
    
  } catch (err) {
    status.textContent = 'Erro: ' + err.message;
    status.className = 'status error';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Comprar via M-Pesa';
  }
});

async function pollPayment(paymentId) {
  let attempts = 0;
  const interval = setInterval(async () => {
    attempts++;
    if (attempts > 20) {
      clearInterval(interval);
      return;
    }
    
    try {
      const res = await fetch(`/api/payment-status/${paymentId}`);
      const data = await res.json();
      
      if (data.status === 'confirmed') {
        clearInterval(interval);
        document.getElementById('status').innerHTML = 
          'Pagamento confirmado!<br>Seus bilhetes foram reservados.<br>Boa sorte!';
        document.getElementById('status').className = 'status success';
      }
    } catch (e) {
      // Silencioso
    }
  }, 4000);
}
</script>
</body>
</html>
