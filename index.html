<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rifa Di√°ria - Sistema de Apostas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Design minimalista preto e branco */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        .ticket-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        /* Adicionando scroll para hist√≥ricos */
        .history-scroll {
            max-height: 300px;
            overflow-y: auto;
        }
        .history-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .history-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .history-scroll::-webkit-scrollbar-thumb {
            background: #000;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-black min-h-screen text-white">
    
    <!-- Tela de Login/Registro -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md fade-in border-2 border-black">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-black mb-2">üé≤ Rifa Di√°ria</h1>
                <p class="text-gray-700">Sistema de Apostas Online</p>
            </div>

            <!-- Formul√°rio de Login -->
            <div id="loginForm">
                <h2 class="text-2xl font-semibold text-black mb-6">Entrar</h2>
                <form id="loginFormElement" class="space-y-4">
                    <div>
                        <label class="block text-black mb-2 font-medium">N√∫mero M-Pesa</label>
                        <input type="text" id="loginMpesa" placeholder="84XXXXXXX ou 85XXXXXXX" 
                               class="w-full px-4 py-3 rounded-lg border-2 border-black focus:border-gray-600 outline-none text-black"
                               required pattern="8[45]\d{7}">
                    </div>
                    <div>
                        <label class="block text-black mb-2 font-medium">Senha</label>
                        <input type="password" id="loginPassword" placeholder="M√≠nimo 4 caracteres"
                               class="w-full px-4 py-3 rounded-lg border-2 border-black focus:border-gray-600 outline-none text-black"
                               required minlength="4">
                    </div>
                    <button type="submit" class="w-full bg-black hover:bg-gray-800 text-white font-semibold py-3 rounded-lg transition duration-200">
                        Entrar
                    </button>
                </form>
                <p class="text-center mt-6 text-gray-700">
                    Ainda n√£o tem conta? 
                    <button onclick="toggleAuthForm()" class="text-black hover:text-gray-700 font-semibold underline">Registrar</button>
                </p>
            </div>

            <!-- Formul√°rio de Registro -->
            <div id="registerForm" class="hidden">
                <h2 class="text-2xl font-semibold text-black mb-6">Criar Conta</h2>
                <form id="registerFormElement" class="space-y-4">
                    <div>
                        <label class="block text-black mb-2 font-medium">Nome Completo</label>
                        <input type="text" id="registerName" placeholder="Seu nome completo"
                               class="w-full px-4 py-3 rounded-lg border-2 border-black focus:border-gray-600 outline-none text-black"
                               required>
                    </div>
                    <div>
                        <label class="block text-black mb-2 font-medium">N√∫mero M-Pesa</label>
                        <input type="text" id="registerMpesa" placeholder="84XXXXXXX ou 85XXXXXXX"
                               class="w-full px-4 py-3 rounded-lg border-2 border-black focus:border-gray-600 outline-none text-black"
                               required pattern="8[45]\d{7}">
                    </div>
                    <div>
                        <label class="block text-black mb-2 font-medium">Senha</label>
                        <input type="password" id="registerPassword" placeholder="M√≠nimo 4 caracteres"
                               class="w-full px-4 py-3 rounded-lg border-2 border-black focus:border-gray-600 outline-none text-black"
                               required minlength="4">
                    </div>
                    <button type="submit" class="w-full bg-black hover:bg-gray-800 text-white font-semibold py-3 rounded-lg transition duration-200">
                        Criar Conta
                    </button>
                </form>
                <p class="text-center mt-6 text-gray-700">
                    J√° tem conta? 
                    <button onclick="toggleAuthForm()" class="text-black hover:text-gray-700 font-semibold underline">Entrar</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Tela Principal da Rifa -->
    <div id="rifaScreen" class="hidden min-h-screen p-4 pb-20">
        <div class="max-w-6xl mx-auto">
            <!-- Header sem saldo -->
            <div class="bg-white rounded-lg shadow-lg p-4 mb-4 fade-in border-2 border-white">
                <div class="flex justify-between items-center flex-wrap gap-3">
                    <div>
                        <h1 class="text-2xl font-bold text-black">üé≤ Rifa Di√°ria</h1>
                        <p class="text-sm text-gray-700"><span id="userName" class="font-semibold"></span></p>
                    </div>
                    <button onclick="logout()" class="bg-black hover:bg-gray-800 text-white px-4 py-2 rounded-lg transition text-sm font-medium">
                        Sair
                    </button>
                </div>
            </div>

            <!-- Contador mais compacto -->
            <div class="bg-white rounded-lg shadow-lg p-4 mb-4 fade-in border-2 border-white">
                <div class="text-center">
                    <p class="text-sm mb-1 text-black font-medium">‚è∞ Pr√≥ximo Sorteio</p>
                    <p id="countdown" class="text-3xl font-bold pulse-animation text-black">03:00</p>
                </div>
            </div>

            <!-- Sele√ß√£o de n√∫meros mais compacta -->
            <div class="bg-white rounded-lg shadow-lg p-4 mb-4 fade-in border-2 border-white">
                <h2 class="text-xl font-bold text-black mb-2">Escolha 5 N√∫meros (1-100)</h2>
                <p class="text-sm text-gray-700 mb-3">Custo: <span class="font-bold text-black">25 MZN</span></p>
                
                <div id="numbersGrid" class="grid grid-cols-10 gap-1.5 mb-4">
                    <!-- N√∫meros gerados via JavaScript -->
                </div>

                <div class="flex justify-between items-center flex-wrap gap-3">
                    <div>
                        <p class="text-sm text-black font-medium">Selecionados: <span id="selectedCount" class="font-bold">0</span>/5</p>
                        <div id="selectedNumbers" class="flex gap-1.5 mt-1.5 flex-wrap"></div>
                    </div>
                    <button id="buyButton" onclick="buyTicket()" disabled
                            class="bg-black hover:bg-gray-800 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-semibold px-6 py-2 rounded-lg transition text-sm">
                        Comprar Bilhete
                    </button>
                </div>
            </div>

            <!-- Hist√≥rico do jogador compacto com scroll e limite de 5 itens -->
            <div class="bg-white rounded-lg shadow-lg p-4 mb-4 fade-in border-2 border-white">
                <h2 class="text-xl font-bold text-black mb-3">üìã Minhas Apostas</h2>
                <div id="playerHistory" class="history-scroll space-y-2">
                    <p class="text-gray-600 text-center py-3 text-sm">Nenhuma aposta ainda</p>
                </div>
            </div>

            <!-- Hist√≥rico de sorteios compacto -->
            <div class="bg-white rounded-lg shadow-lg p-4 fade-in border-2 border-white">
                <h2 class="text-xl font-bold text-black mb-3">üèÜ √öltimo Resultado</h2>
                <div id="drawHistory" class="space-y-2">
                    <p class="text-gray-600 text-center py-3 text-sm">Nenhum sorteio realizado ainda</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Compra Confirmada -->
    <div id="purchaseModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full fade-in border-2 border-black">
            <div class="text-center">
                <div class="text-6xl mb-4">‚úÖ</div>
                <h2 class="text-3xl font-bold text-black mb-4">Compra Confirmada!</h2>
                <p class="text-gray-700 mb-2 font-medium">Seus n√∫meros:</p>
                <div id="purchasedNumbers" class="flex justify-center gap-2 mb-4 flex-wrap"></div>
                <p class="text-gray-700 mb-6">Boa sorte no pr√≥ximo sorteio!</p>
                <button onclick="closePurchaseModal()" class="bg-black hover:bg-gray-800 text-white font-semibold px-8 py-3 rounded-lg transition duration-200">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Resultado do Sorteio -->
    <div id="resultModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full fade-in border-2 border-black">
            <div class="text-center">
                <div id="resultIcon" class="text-6xl mb-4">üéâ</div>
                <h2 id="resultTitle" class="text-3xl font-bold text-black mb-4">Resultado do Sorteio</h2>
                <p class="text-gray-700 mb-2 font-medium">N√∫meros sorteados:</p>
                <div id="drawnNumbers" class="flex justify-center gap-2 mb-4 flex-wrap"></div>
                <div id="resultMessage" class="text-lg font-semibold mb-6"></div>
                <button onclick="closeResultModal()" class="bg-black hover:bg-gray-800 text-white font-semibold px-8 py-3 rounded-lg transition duration-200">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Pagamento M-Pesa -->
    <div id="mpesaModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full fade-in border-2 border-black">
            <div class="text-center">
                <div class="text-6xl mb-4">üì±</div>
                <h2 class="text-3xl font-bold text-black mb-4">Pagamento M-Pesa</h2>
                <p class="text-gray-700 mb-2">Valor a pagar:</p>
                <p class="text-4xl font-bold text-black mb-4">25 MZN</p>
                <p class="text-sm text-gray-600 mb-6">Digite seu PIN M-Pesa para confirmar</p>
                
                <input type="password" id="mpesaPin" maxlength="4" placeholder="****"
                       class="w-32 mx-auto text-center text-2xl px-4 py-3 rounded-lg border-2 border-black focus:border-gray-600 outline-none text-black mb-6 tracking-widest">
                
                <div class="flex gap-3">
                    <button onclick="cancelMpesaPayment()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-black font-semibold px-6 py-3 rounded-lg transition duration-200 border-2 border-black">
                        Cancelar
                    </button>
                    <button onclick="confirmMpesaPayment()" class="flex-1 bg-black hover:bg-gray-800 text-white font-semibold px-6 py-3 rounded-lg transition duration-200">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== CONSTANTES E VARI√ÅVEIS GLOBAIS ==========
        const TICKET_COST = 25;
        const DRAW_INTERVAL = 180; // 3 minutos em segundos
        
        let currentUser = null;
        let selectedNumbers = [];
        let nextDrawTime = null;
        let countdownInterval = null;
        let pendingPurchase = null; // Para armazenar compra pendente durante pagamento

        // ========== FUN√á√ïES DE AUTENTICA√á√ÉO ==========
        
        function toggleAuthForm() {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            loginForm.classList.toggle('hidden');
            registerForm.classList.toggle('hidden');
        }

        function register(name, mpesa, password) {
            const users = JSON.parse(localStorage.getItem('rifa_users_v1') || '{}');
            
            if (users[mpesa]) {
                alert('Este n√∫mero M-Pesa j√° est√° registrado!');
                return false;
            }

            users[mpesa] = { name, password };
            localStorage.setItem('rifa_users_v1', JSON.stringify(users));
            
            // Inicializar saldo do novo usu√°rio
            localStorage.setItem(`rifa_balance_${mpesa}`, TICKET_COST.toString());
            
            alert('Conta criada com sucesso! Fa√ßa login para continuar.');
            toggleAuthForm();
            return true;
        }

        function login(mpesa, password) {
            const users = JSON.parse(localStorage.getItem('rifa_users_v1') || '{}');
            
            if (!users[mpesa]) {
                alert('N√∫mero M-Pesa n√£o encontrado!');
                return false;
            }

            if (users[mpesa].password !== password) {
                alert('Senha incorreta!');
                return false;
            }

            currentUser = { mpesa, name: users[mpesa].name };
            sessionStorage.setItem('rifa_session', JSON.stringify(currentUser));
            
            // Carregar saldo do usu√°rio
            const balance = parseInt(localStorage.getItem(`rifa_balance_${mpesa}`) || TICKET_COST);
            
            showRifaScreen();
            return true;
        }

        function logout() {
            sessionStorage.removeItem('rifa_session');
            currentUser = null;
            selectedNumbers = [];
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('rifaScreen').classList.add('hidden');
        }

        function showRifaScreen() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('rifaScreen').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.name;
            generateNumbersGrid();
            initializeDrawSystem();
            loadPlayerHistory();
            loadDrawHistory();
        }

        // ========== FUN√á√ïES DA RIFA ==========

        function generateNumbersGrid() {
            const grid = document.getElementById('numbersGrid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= 100; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = 'ticket-hover bg-white hover:bg-black hover:text-white text-black font-semibold py-2 text-sm rounded-lg transition duration-200 border-2 border-black';
                button.onclick = () => toggleNumber(i, button);
                grid.appendChild(button);
            }
        }

        function toggleNumber(number, button) {
            const index = selectedNumbers.indexOf(number);
            
            if (index > -1) {
                selectedNumbers.splice(index, 1);
                button.classList.remove('bg-black', 'text-white');
                button.classList.add('bg-white', 'text-black');
            } else {
                if (selectedNumbers.length >= 5) {
                    alert('Voc√™ j√° selecionou 5 n√∫meros!');
                    return;
                }
                selectedNumbers.push(number);
                button.classList.remove('bg-white', 'text-black');
                button.classList.add('bg-black', 'text-white');
            }

            selectedNumbers.sort((a, b) => a - b);
            updateSelectedDisplay();
        }

        function updateSelectedDisplay() {
            document.getElementById('selectedCount').textContent = selectedNumbers.length;
            
            const container = document.getElementById('selectedNumbers');
            container.innerHTML = selectedNumbers.map(num => 
                `<span class="bg-black text-white px-2 py-0.5 rounded-full font-semibold text-xs border border-black">${num}</span>`
            ).join('');

            document.getElementById('buyButton').disabled = selectedNumbers.length !== 5;
        }

        function buyTicket() {
            if (selectedNumbers.length !== 5) {
                alert('Selecione exatamente 5 n√∫meros!');
                return;
            }

            pendingPurchase = {
                numbers: [...selectedNumbers],
                timestamp: new Date().toISOString()
            };
            
            showMpesaModal();
        }

        function showMpesaModal() {
            document.getElementById('mpesaModal').classList.remove('hidden');
            document.getElementById('mpesaPin').value = '';
            document.getElementById('mpesaPin').focus();
        }

        function cancelMpesaPayment() {
            document.getElementById('mpesaModal').classList.add('hidden');
            pendingPurchase = null;
        }

        function confirmMpesaPayment() {
            const pin = document.getElementById('mpesaPin').value;
            
            if (pin.length !== 4) {
                alert('Digite um PIN de 4 d√≠gitos!');
                return;
            }

            // Simular processamento
            document.getElementById('mpesaModal').classList.add('hidden');
            
            // Processar compra
            const purchases = JSON.parse(localStorage.getItem('rifa_purchases_v1') || '[]');
            const purchase = {
                id: Date.now(),
                user: currentUser.mpesa,
                numbers: pendingPurchase.numbers,
                timestamp: pendingPurchase.timestamp,
                cost: TICKET_COST
            };
            purchases.push(purchase);
            localStorage.setItem('rifa_purchases_v1', JSON.stringify(purchases));

            // Mostrar modal de confirma√ß√£o
            showPurchaseModal();

            // Resetar sele√ß√£o
            const numbersToShow = [...selectedNumbers];
            selectedNumbers = [];
            generateNumbersGrid();
            updateSelectedDisplay();
            loadPlayerHistory();
            
            pendingPurchase = null;
        }

        // ========== FUN√á√ïES DE SORTEIO ==========

        function initializeDrawSystem() {
            // Verificar se h√° um pr√≥ximo sorteio agendado
            const savedNextDraw = localStorage.getItem('rifa_next_draw_time');
            const now = Date.now();

            if (savedNextDraw && parseInt(savedNextDraw) > now) {
                nextDrawTime = parseInt(savedNextDraw);
            } else {
                // Agendar pr√≥ximo sorteio em 3 minutos
                nextDrawTime = now + (DRAW_INTERVAL * 1000);
                localStorage.setItem('rifa_next_draw_time', nextDrawTime.toString());
            }

            startCountdown();
        }

        function startCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            countdownInterval = setInterval(() => {
                const now = Date.now();
                const diff = nextDrawTime - now;

                if (diff <= 0) {
                    performDraw();
                    // Agendar pr√≥ximo sorteio
                    nextDrawTime = Date.now() + (DRAW_INTERVAL * 1000);
                    localStorage.setItem('rifa_next_draw_time', nextDrawTime.toString());
                }

                const minutes = Math.floor(diff / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                document.getElementById('countdown').textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        function performDraw() {
            const purchases = JSON.parse(localStorage.getItem('rifa_purchases_v1') || '[]');
            
            if (purchases.length === 0) {
                console.log('[v0] Nenhuma aposta para sortear');
                return;
            }

            // Gerar 5 n√∫meros aleat√≥rios
            const drawnNumbers = [];
            while (drawnNumbers.length < 5) {
                const num = Math.floor(Math.random() * 100) + 1;
                if (!drawnNumbers.includes(num)) {
                    drawnNumbers.push(num);
                }
            }
            drawnNumbers.sort((a, b) => a - b);

            console.log('[v0] Sorteio realizado:', drawnNumbers);

            // Verificar vencedores
            const results = [];

            purchases.forEach(purchase => {
                const matches = purchase.numbers.filter(num => drawnNumbers.includes(num)).length;
                let prize = 0;
                let status = 'Perdeu';

                if (matches === 3) {
                    prize = 25;
                    status = 'Reembolso';
                } else if (matches === 5) {
                    prize = 5000;
                    status = 'GANHOU!';
                }

                results.push({
                    user: purchase.user,
                    numbers: purchase.numbers,
                    matches,
                    prize,
                    status
                });
            });

            // Salvar hist√≥rico do sorteio
            const history = JSON.parse(localStorage.getItem('rifa_history_v1') || '[]');
            history.unshift({
                timestamp: new Date().toISOString(),
                numbers: drawnNumbers,
                results,
                totalBets: purchases.length
            });
            localStorage.setItem('rifa_history_v1', JSON.stringify(history.slice(0, 20)));

            // Salvar hist√≥rico individual de cada jogador
            const playerHistory = JSON.parse(localStorage.getItem('rifa_player_history_v1') || '{}');
            
            results.forEach(result => {
                if (!playerHistory[result.user]) {
                    playerHistory[result.user] = [];
                }
                
                playerHistory[result.user].unshift({
                    timestamp: new Date().toISOString(),
                    drawnNumbers,
                    myNumbers: result.numbers,
                    matches: result.matches,
                    prize: result.prize,
                    status: result.status
                });
            });
            
            localStorage.setItem('rifa_player_history_v1', JSON.stringify(playerHistory));

            // Limpar compras pendentes
            localStorage.setItem('rifa_purchases_v1', '[]');

            // Mostrar resultado para o usu√°rio atual se ele participou
            if (currentUser) {
                const userResults = results.filter(r => r.user === currentUser.mpesa);
                if (userResults.length > 0) {
                    // Mostrar o melhor resultado se houver m√∫ltiplas apostas
                    const bestResult = userResults.reduce((best, current) => 
                        current.prize > best.prize ? current : best
                    );
                    showResultModal(drawnNumbers, bestResult);
                }
                
                loadPlayerHistory();
                loadDrawHistory();
            }
        }

        // ========== FUN√á√ïES DE HIST√ìRICO ==========

        function loadPlayerHistory() {
            const playerHistory = JSON.parse(localStorage.getItem('rifa_player_history_v1') || '{}');
            const userHistory = playerHistory[currentUser.mpesa] || [];
            
            // Buscar apostas pendentes do usu√°rio
            const purchases = JSON.parse(localStorage.getItem('rifa_purchases_v1') || '[]');
            const userPendingBets = purchases.filter(p => p.user === currentUser.mpesa);
            
            const container = document.getElementById('playerHistory');

            if (userHistory.length === 0 && userPendingBets.length === 0) {
                container.innerHTML = '<p class="text-gray-600 text-center py-3 text-sm">Nenhuma aposta ainda</p>';
                return;
            }

            let html = '';

            // Mostrar apostas pendentes primeiro (m√°ximo 3)
            if (userPendingBets.length > 0) {
                html += userPendingBets.slice(0, 3).map(bet => `
                    <div class="border-2 border-black rounded-lg p-3 bg-yellow-50">
                        <div class="flex justify-between items-start mb-1">
                            <div>
                                <p class="text-xs text-gray-700">${new Date(bet.timestamp).toLocaleString('pt-BR', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'})}</p>
                                <p class="font-semibold text-black text-sm">N√∫meros: ${bet.numbers.join(', ')}</p>
                            </div>
                            <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-yellow-400 text-black border border-black">
                                ‚è≥ Aguardando
                            </span>
                        </div>
                    </div>
                `).join('');
            }

            // Mostrar hist√≥rico de resultados (m√°ximo 5 total incluindo pendentes)
            const remainingSlots = 5 - userPendingBets.slice(0, 3).length;
            html += userHistory.slice(0, remainingSlots).map(entry => `
                <div class="border-2 border-black rounded-lg p-3 bg-white">
                    <div class="flex justify-between items-start mb-1">
                        <div class="flex-1">
                            <p class="text-xs text-gray-700">${new Date(entry.timestamp).toLocaleString('pt-BR', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'})}</p>
                            <p class="font-semibold text-black text-sm">Meus: ${entry.myNumbers.join(', ')}</p>
                            <p class="text-xs text-gray-700">Sorteio: ${entry.drawnNumbers.join(', ')}</p>
                        </div>
                        <span class="px-2 py-0.5 rounded-full text-xs font-semibold border ${
                            entry.status === 'GANHOU!' ? 'bg-black text-white border-black' :
                            entry.status === 'Reembolso' ? 'bg-white text-black border-black' :
                            'bg-gray-200 text-gray-700 border-gray-400'
                        }">
                            ${entry.status}
                        </span>
                    </div>
                    <p class="text-xs text-black">Acertos: <span class="font-bold">${entry.matches}</span> | Pr√™mio: <span class="font-bold">${entry.prize} MZN</span></p>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function loadDrawHistory() {
            const history = JSON.parse(localStorage.getItem('rifa_history_v1') || '[]');
            const container = document.getElementById('drawHistory');

            if (history.length === 0) {
                container.innerHTML = '<p class="text-gray-600 text-center py-3 text-sm">Nenhum sorteio realizado ainda</p>';
                return;
            }

            const draw = history[0];
            const winners = draw.results.filter(r => r.prize > 0);
            const totalPrizes = winners.reduce((sum, r) => sum + r.prize, 0);
            
            container.innerHTML = `
                <div class="border-2 border-black rounded-lg p-4 bg-white">
                    <div class="mb-2">
                        <p class="text-xs text-gray-700 mb-1">${new Date(draw.timestamp).toLocaleString('pt-BR', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'})}</p>
                        <p class="font-bold text-black text-lg">N√∫meros Sorteados:</p>
                        <div class="flex gap-2 mt-2 flex-wrap">
                            ${draw.numbers.map(num => `
                                <span class="bg-black text-white px-4 py-2 rounded-full font-bold text-lg border-2 border-black">${num}</span>
                            `).join('')}
                        </div>
                    </div>
                    ${winners.length > 0 ? `
                        <div class="mt-3 pt-3 border-t-2 border-gray-200">
                            <p class="text-sm text-gray-700">
                                <span class="font-semibold text-black">${winners.length}</span> vencedor(es) | 
                                Pr√™mios: <span class="font-bold text-black">${totalPrizes} MZN</span>
                            </p>
                        </div>
                    ` : `
                        <p class="text-sm text-gray-600 mt-3 pt-3 border-t-2 border-gray-200">Nenhum vencedor neste sorteio</p>
                    `}
                </div>
            `;
        }

        // ========== FUN√á√ïES DE MODAL ==========

        function showPurchaseModal() {
            const modal = document.getElementById('purchaseModal');
            const numbersContainer = document.getElementById('purchasedNumbers');
            
            numbersContainer.innerHTML = pendingPurchase.numbers.map(num => 
                `<span class="bg-black text-white px-4 py-2 rounded-full font-bold text-lg border-2 border-black">${num}</span>`
            ).join('');
            
            modal.classList.remove('hidden');
        }

        function closePurchaseModal() {
            document.getElementById('purchaseModal').classList.add('hidden');
        }

        function showResultModal(drawnNumbers, result) {
            const modal = document.getElementById('resultModal');
            const numbersContainer = document.getElementById('drawnNumbers');
            const messageContainer = document.getElementById('resultMessage');
            const iconContainer = document.getElementById('resultIcon');
            const titleContainer = document.getElementById('resultTitle');

            numbersContainer.innerHTML = drawnNumbers.map(num => 
                `<span class="bg-black text-white px-4 py-2 rounded-full font-bold text-lg border-2 border-black">${num}</span>`
            ).join('');

            if (result.status === 'GANHOU!') {
                iconContainer.textContent = 'üéâ';
                titleContainer.textContent = 'PARAB√âNS!';
                messageContainer.innerHTML = `<p class="text-black">Voc√™ acertou 5 n√∫meros!</p><p class="text-2xl font-bold text-black mt-2">Pr√™mio: ${result.prize} MZN</p>`;
            } else if (result.status === 'Reembolso') {
                iconContainer.textContent = 'üí∞';
                titleContainer.textContent = 'Reembolso!';
                messageContainer.innerHTML = `<p class="text-black">Voc√™ acertou 3 n√∫meros!</p><p class="text-xl font-bold text-black mt-2">Reembolso: ${result.prize} MZN</p>`;
            } else {
                iconContainer.textContent = 'üòî';
                titleContainer.textContent = 'N√£o foi desta vez';
                messageContainer.innerHTML = `<p class="text-gray-700">Voc√™ acertou ${result.matches} n√∫mero(s)</p><p class="text-sm text-gray-600 mt-2">Tente novamente!</p>`;
            }

            modal.classList.remove('hidden');
        }

        function closeResultModal() {
            document.getElementById('resultModal').classList.add('hidden');
        }

        // ========== EVENT LISTENERS ==========

        document.getElementById('loginFormElement').addEventListener('submit', (e) => {
            e.preventDefault();
            const mpesa = document.getElementById('loginMpesa').value;
            const password = document.getElementById('loginPassword').value;
            login(mpesa, password);
        });

        document.getElementById('registerFormElement').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const mpesa = document.getElementById('registerMpesa').value;
            const password = document.getElementById('registerPassword').value;
            register(name, mpesa, password);
        });

        // ========== INICIALIZA√á√ÉO ==========

        window.addEventListener('load', () => {
            const session = sessionStorage.getItem('rifa_session');
            if (session) {
                currentUser = JSON.parse(session);
                showRifaScreen();
            }
        });
    </script>
</body>
</html>
